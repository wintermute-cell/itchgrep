version: '3'

tasks:
  dataservice-local:
    cmds:
      - task: prepare-db-volume
      - docker run --name dynamodb-local -d -p 8000:8000 -v $(pwd)/local_data/shared-local-instance.db:/home/dynamodblocal/shared-local-instance.db amazon/dynamodb-local -jar DynamoDBLocal.jar -sharedDb -dbPath /home/dynamodblocal
      - defer: docker stop dynamodb-local && docker rm dynamodb-local
      - go run ./cmd/dataservice/main.go
    env:
      DYNAMO_LOCAL: true

  explore-data:
    cmds:
      - task: prepare-db-volume
      - docker run --name dynamodb-local -d -p 8000:8000 -v $(pwd)/local_data/shared-local-instance.db:/home/dynamodblocal/shared-local-instance.db amazon/dynamodb-local -jar DynamoDBLocal.jar -sharedDb -dbPath /home/dynamodblocal
      - defer: docker stop dynamodb-local && docker rm dynamodb-local
      - docker exec -it dynamodb-local sqlite3 /home/dynamodblocal/shared-local-instance.db

  webserver-local:
    cmds:
      - task: prepare-db-volume
      - docker network create itchgrep-network
      - defer: docker network rm itchgrep-network
      - docker run --name dynamodb-local --network itchgrep-network -d -p 8000:8000 -v $(pwd)/local_data/shared-local-instance.db:/home/dynamodblocal/shared-local-instance.db amazon/dynamodb-local -jar DynamoDBLocal.jar -sharedDb -dbPath /home/dynamodblocal
      - defer: docker stop dynamodb-local && docker rm dynamodb-local
      - docker build -t itchgrep-webserver .
      - defer: docker stop itchgrep-webserver-local && docker rm itchgrep-webserver-local
      - docker run --name itchgrep-webserver-local --network itchgrep-network -p 8080:8080 -e DYNAMO_LOCAL=true -e DOCKER=true itchgrep-webserver

  templ:
    cmds:
      - templ generate

  test:
    cmds:
      - task: test-db

  test-db:
    cmds:
      - docker run --name dynamodb-local -d -p 8000:8000 amazon/dynamodb-local
      - defer: docker stop dynamodb-local && docker rm dynamodb-local
      - go test -v ./...
    silent: false


  # --------------------------------
  # INTERNAL TASKS, NOT FOR RUNNING
  # --------------------------------

  prepare-db-volume:
    internal: true
    cmds:
      - mkdir -p "$(pwd)/local_data"
      - touch "$(pwd)/local_data/shared-local-instance.db"
